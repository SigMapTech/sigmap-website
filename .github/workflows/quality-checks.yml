name: Quality Checks

on:
  push:
    branches:
      - main
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
  pull_request:
    branches:
      - main
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
  workflow_dispatch:

jobs:
  html-validation:
    name: HTML Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install html-validate
        run: npm install -g html-validate

      - name: Create html-validate config
        run: |
          cat > .htmlvalidate.json << 'EOF'
          {
            "extends": ["html-validate:recommended"],
            "rules": {
              "no-trailing-whitespace": "off",
              "void-style": "off",
              "attribute-boolean-style": "off"
            }
          }
          EOF

      - name: Validate HTML files
        run: |
          echo "Validating HTML files..."
          html-validate "**/*.html" --formatter stylish

  css-validation:
    name: CSS Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install stylelint
        run: npm install -g stylelint stylelint-config-standard

      - name: Create stylelint config
        run: |
          cat > .stylelintrc.json << 'EOF'
          {
            "extends": "stylelint-config-standard",
            "rules": {
              "no-descending-specificity": null,
              "font-family-no-missing-generic-family-keyword": null,
              "selector-class-pattern": null,
              "custom-property-pattern": null,
              "keyframes-name-pattern": null,
              "alpha-value-notation": null,
              "color-function-notation": null
            }
          }
          EOF

      - name: Validate CSS files
        run: |
          echo "Validating CSS files..."
          stylelint "**/*.css" --formatter verbose || true

  accessibility:
    name: Accessibility Testing (axe-core)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g @axe-core/cli http-server

      - name: Start local server
        run: |
          http-server -p 8080 &
          sleep 3

      - name: Run axe accessibility tests
        run: |
          echo "Running accessibility tests..."
          axe http://localhost:8080/index.html --exit --tags wcag2a,wcag2aa,wcag21a,wcag21aa --reporter v2
          axe http://localhost:8080/2048/privacy-policy.html --exit --tags wcag2a,wcag2aa,wcag21a,wcag21aa --reporter v2

  lighthouse:
    name: Lighthouse Performance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli http-server

      - name: Create lighthouserc.js
        run: |
          cat > lighthouserc.js << 'EOF'
          module.exports = {
            ci: {
              collect: {
                staticDistDir: './',
                url: ['http://localhost/index.html', 'http://localhost/2048/privacy-policy.html'],
                numberOfRuns: 1
              },
              assert: {
                assertions: {
                  'categories:performance': ['warn', { minScore: 0.8 }],
                  'categories:accessibility': ['error', { minScore: 0.9 }],
                  'categories:best-practices': ['warn', { minScore: 0.8 }],
                  'categories:seo': ['warn', { minScore: 0.8 }]
                }
              },
              upload: {
                target: 'temporary-public-storage'
              }
            }
          };
          EOF

      - name: Run Lighthouse CI
        run: |
          echo "Running Lighthouse performance checks..."
          lhci autorun || echo "Lighthouse completed with warnings"

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30

  link-checker:
    name: Broken Link Checker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install lychee link checker
        run: |
          curl -sLO https://github.com/lycheeverse/lychee/releases/download/v0.15.1/lychee-v0.15.1-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf lychee-v0.15.1-x86_64-unknown-linux-gnu.tar.gz
          chmod +x lychee
          sudo mv lychee /usr/local/bin/

      - name: Check for broken links
        run: |
          echo "Checking for broken links..."
          lychee --verbose --no-progress \
            --exclude "^mailto:" \
            --exclude "^tel:" \
            --exclude "localhost" \
            --exclude "127.0.0.1" \
            --exclude "formspree.io" \
            --accept "200,204,206,301,302,304,307,308" \
            --timeout 30 \
            --retry-wait-time 5 \
            --max-retries 3 \
            "**/*.html" "**/*.md" || echo "Link check completed with warnings"

      - name: Upload link check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: link-check-results
          path: lychee-report.md
          retention-days: 30
          if-no-files-found: ignore
